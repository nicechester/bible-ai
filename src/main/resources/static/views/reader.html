<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Reader - 개역개정</title>
    
    <style>
        :root {
            --primary-color: #28a745;
            --primary-hover: #218838;
            --border-color: #e0e0e0;
            --text-primary: #212529;
            --text-secondary: #666;
            --bg-light: #fafafa;
            --highlight-bg: #e7f5e7;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Georgia, 'Times New Roman', serif;
            line-height: 1.8;
            color: var(--text-primary);
            background: var(--bg-light);
        }
        
        .reader-header {
            position: sticky;
            top: 0;
            padding: 16px 24px;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .reader-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .nav-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .nav-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chapter-select {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
        }
        
        .reader-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 32px 24px;
            background: white;
            min-height: calc(100vh - 60px);
        }
        
        .book-title {
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 24px;
            color: var(--primary-color);
        }
        
        .chapter-number {
            font-size: 20px;
            text-align: center;
            margin-bottom: 24px;
            color: var(--text-secondary);
        }
        
        .verse-container {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .verse-container:hover {
            background: var(--bg-light);
        }
        
        .verse-container.highlighted {
            background: var(--highlight-bg);
            border-left: 3px solid var(--primary-color);
        }
        
        .verse-number {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.85em;
            margin-right: 8px;
            cursor: pointer;
            display: inline-block;
            min-width: 24px;
        }
        
        .verse-number:hover {
            text-decoration: underline;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 24px 0 12px 0;
            padding-left: 12px;
            border-left: 3px solid var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .error {
            padding: 20px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            margin: 20px;
        }
        
        .back-link {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .back-link:hover {
            transform: scale(1.05);
        }
        
        @media (max-width: 600px) {
            .reader-content { padding: 16px; }
            .book-title { font-size: 22px; }
            .nav-btn { padding: 6px 12px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div id="reader-root">
        <div class="loading">Loading...</div>
    </div>
    
    <a href="/" class="back-link">← Back to Bible AI</a>
    
    <script>
        // Parse URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                book: params.get('book') || '창',
                chapter: parseInt(params.get('chapter')) || 1,
                verse: parseInt(params.get('verse')) || null
            };
        }
        
        // Fetch chapter data
        async function fetchChapter(book, chapter) {
            const response = await fetch(`/api/bible/${encodeURIComponent(book)}/${chapter}`);
            if (!response.ok) throw new Error('Chapter not found');
            return response.json();
        }
        
        // Render the reader
        async function renderReader() {
            const root = document.getElementById('reader-root');
            const { book, chapter, verse } = getUrlParams();
            
            try {
                const data = await fetchChapter(book, chapter);
                
                let html = `
                    <div class="reader-header">
                        <div class="reader-title">${data.bookName}</div>
                        <div class="nav-controls">
                            <button class="nav-btn" onclick="navigateChapter(-1)" ${chapter <= 1 ? 'disabled' : ''}>← Prev</button>
                            <select class="chapter-select" onchange="goToChapter(this.value)">
                                ${Array.from({length: data.totalChapters}, (_, i) => 
                                    `<option value="${i+1}" ${i+1 === chapter ? 'selected' : ''}>${i+1}장</option>`
                                ).join('')}
                            </select>
                            <button class="nav-btn" onclick="navigateChapter(1)" ${chapter >= data.totalChapters ? 'disabled' : ''}>Next →</button>
                        </div>
                    </div>
                    <div class="reader-content">
                        <h1 class="book-title">${data.bookName}</h1>
                        <div class="chapter-number">제 ${chapter} 장</div>
                `;
                
                for (const v of data.verses) {
                    if (v.title) {
                        html += `<div class="section-title">${v.title}</div>`;
                    }
                    
                    const highlighted = verse && v.verse === verse ? 'highlighted' : '';
                    html += `
                        <div class="verse-container ${highlighted}" id="verse-${v.verse}">
                            <span class="verse-number" onclick="copyVerseRef('${data.bookName} ${chapter}:${v.verse}')">${v.verse}</span>
                            <span class="verse-text">${v.text}</span>
                        </div>
                    `;
                }
                
                html += '</div>';
                root.innerHTML = html;
                
                // Scroll to highlighted verse
                if (verse) {
                    setTimeout(() => {
                        const el = document.getElementById(`verse-${verse}`);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
                
                // Update URL and title
                document.title = `${data.bookName} ${chapter}장 - Bible Reader`;
                
            } catch (err) {
                root.innerHTML = `<div class="error">Error loading chapter: ${err.message}</div>`;
            }
        }
        
        // Navigation functions
        window.navigateChapter = function(delta) {
            const { book, chapter } = getUrlParams();
            const newChapter = chapter + delta;
            window.location.href = `/views/reader.html?book=${book}&chapter=${newChapter}`;
        };
        
        window.goToChapter = function(chapterNum) {
            const { book } = getUrlParams();
            window.location.href = `/views/reader.html?book=${book}&chapter=${chapterNum}`;
        };
        
        window.copyVerseRef = function(ref) {
            navigator.clipboard.writeText(ref).then(() => {
                alert(`Copied: ${ref}`);
            });
        };
        
        // Initialize
        renderReader();
    </script>
</body>
</html>
